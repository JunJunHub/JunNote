<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

<h1 align = "center" > 分布式显控拼接屏输出同步方案 </h1>
<center> (仅供内部使用) </center>
<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

|                                     版  本  号： | V0.1          |
| -------------------------------------------: | :------------ |
| &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;保 密 等 级： | ■秘密  □机密  □绝密 |
|                                         编 制： | 李永军           |
|                                         审 核： | 李永军           |
|                                              |               |

<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
<h2 align = "left" > 修订记录 </h2>

| 日期         | 版本号 | 描述   | 作者  |
| ---------- | --- | ---- | --- |
| 2025-03-27 | 0.1 | 初稿完成 | 李永军 |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |
|            |     |      |     |



<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
<h2 align = "left" > 目录 </h2>
[TOC]



<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
## 前言

### 关键词
`拼接屏`、`分布式`、`解码输出同步`、`编码同步`、`PTP`

### 摘要
​    以公司NVR基线编解码业务为基础，开发分布式显控输入节点(编码节点)、输出节点(解码节点)。要求多个解码节点输出同一个信号源的画面时支持显示同步。要求多个编码节点对一台高分主机输出画面进行编码时支持编码同步。





<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
## 案例描述

组织各部门开发人员讨论实现方案。整理实现方案，设计业务逻辑。

产品涉及多个部门联合开发，整理设计文档供后期维护排查问题，找到对应责任人。






<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
## 解决过程

### 1、提供产品应用场景描述





### 2、<软件技术中心基础平台开发部>提供基础理论

> 戈志明：提出了实现拼接同步的基础方案，在此基础上设计讨论业务实现
>
> 1. 多个CPU间通过PTP实现主从时间同步（驱动负责实现，业务调用） 
>    第一步是方案的基础，保证多个设备之间 PTP 时钟同步
> 2. 不同CPU之间需要同一时刻使能VO，保证初始化的时候VSYNC是同步的。（业务负责，解码端媒控协助）
>    （1）最准确的方法是硬件信号中断的方式。目前不具备的情况下可以采用下面的方案；
>    （2）PTP时间同步后，多台输出节点的业务可以**约定将来某个时刻**统一开启 VO 输出；
> 3. 多个3588CPU因为时钟不同源，跑一段时间后VSYNC可能出现相位差，需要微调VSYNC（解码端媒控负责实现，业务协助）
>    （1）多个CPU各自监控自己的VSYNC回调时间，计算**单位时间内**的VSYNC的时间总和，从机根据主机的VSYNC时间总和以及从机自身统计的单位时间VSYNC时间总和的差值微调VSYNC。HDMI PHY 内部 PLL。
>    （2）业务定期发送主机的时间戳和单位时间内VSYNC时间总和
> 4. 显示输出送数据帧同步（解码端媒控负责实现，业务协助）
>    （1）利用 VO 缓冲，实现统一时刻发送相同时间戳的视频帧
>    （2）业务定期发送主机的时间戳+当前发送数据帧的时间戳

显控产品设计满足以下四点要求，多个解码节点之间输出同步理论误差可达到 1 帧之内。

1. 实现 PTP 时钟同步，保证各个设备之间纳秒级时钟同步。
2. 保证需要输出同步的多个解码节点在**同一时刻**开启 VO，保证 VSYNC 初始同步。
3. 即使多个设备同一时刻使能 VO，随着时间的推移，VSYNC 可能出现相位差，需要微调 VSYNC。
4. 设计解码输出同步策略，保证各解码节点同一时刻输出相同时间戳的视频帧，规避因网络抖动，业务逻辑引入的误差。



### 3、提供初步的业务开发方案供讨论

针对第四点要求，提供初步的实现思路：
分布式各个解码节点之间是无法感知到其它节点的存在，也不知道与哪些设备上的哪些解码任务保持同步，需要由控制节点统一调度。
控制主节点告知需要输出同步的解码节点加入一个MQTT通讯会话，解码节点定时发送自己的输出视频帧状态，并自行调节自己的输出视频帧。
此方案特点是控制节点提供了一个解码节点之间的通讯通道，控制节点不参与输出同步的调节，调节逻辑由每个解码节点自己判断调节。

> 1、主控发起拼接开窗时创建输出同步 MQTT 会话
>
> 2、需要输出同步的解码器加入这个 MQTT 会话
>
> 3、解码器解密码流，解密成功并解码出第一帧数据后，MQTT 会话中上报：解密解码成功
>
> 4、主控收到所有设备解密解码成功消息之后，主控 MQTT 发起输出同步消息；所有解码器在收到输出同步消息后，MQTT会话中报告自己的最新视频帧状态，并开启定时任务定时上报自己的视频帧显示状态。
>
> 解码器设备定时发送自己的显示状态包含以下参数：
>   任务Id + 系统时间戳 + 当前显示视频帧时间戳 + 缓存帧数
>
> 5、主控收到所有设备的状态报告，MQTT 会话中触发开始显示信令，所有解码器开始输出画面
>
> 解码器依据下面的策略自行调节输出显示视频帧。解码器输出同步调节策略：
>
> 1.同一任务中的解码器发现有设备比自己慢，自动与比自己慢的设备同步
> 2.发现有设备比自己快，且自己没缓存，且超过准许范围立即上报自己的状态。有缓存则显示自动调节
>
> 设定差值范围；设定定时发送间隔。
>
> 由上海业务需要负责mqtt控制逻辑，避免业务间通讯带来的误差。



### 4、讨论确认最终业务实现方案

#### 方案简介

##### PTP 时钟同步基础

RK3588 编解码节点支持 PTP 时钟同步功能集成到 NVRSRV 业务，由上海提供。控制节点支持 PTP 同步由显控业务负责。

##### 解码输出同步方案

@ 解码器支持指定某个时刻，定时开启 VO，NVRSRV 业务封装后提供接口给显控业务使用。

​    指定未来的某个时刻，下发需要同步使能的设备，解码器内部 while 循环，到指定时刻开启使能；一般基于当前时间推迟0.1-5s(各个设备通讯的耗时)

@ 解码器内部根据使能 VO 的 vsync 时间为基准，以及设定的统一刷新率，统计 VSYCN 周期并微调 vsync；

@ 解码器**解码模式支持基于vsync解码**；此模式解码帧率与显示帧率一致，且显示模式固定为流畅模式，不可调；

​    解码器需要提供**切换解码模式**的接口。在其他实时性要求比较高的场景下，支持实时解码。

@  解码器提供查询**某一时刻解码的视频帧时间戳以及待解码视频缓存帧数**。

​    解码后的数据固定缓存一帧，解码之后立即送显。实现输出同步需要保证多个解码器在同一时刻，解码相同时间戳的视频帧。
​    解码器提供此接口口，业务可以通过解码器解码状态，并通过调节解码器快解、慢解

@ 主控业务配置分布式拼接屏时，统一设置刷新率；关闭 VO，并指定统一时刻重新开启 VO (微秒级的时间戳)。

@ 主控业务拼接屏绑定的设备重启时，拼接屏绑定的设备需要全部重新关闭开启 VO，才能保持同步





2、向需要输出同步的解码器查询某一时刻解码视频帧时间戳以及缓存状态    
      任务IdA + vsync时间戳 + 解码视频帧时间戳 + 缓存帧数   
      任务IdB + vsync时间戳 + 解码视频帧时间戳 + 缓存帧数    
      计算两个任务的差值：B-A的vsync时间戳与B-A的视频帧时间戳，获取两个解码视频帧差值  

  3、业务比对解码节奏，哪个解码器解码比较慢，如果缓存帧数大余某个阈值，优先快解N帧，跟上解码节奏；否则以慢的为基准调节其它解码器解码节奏，慢解N帧    业务支持设定解码缓冲上限，缓存帧数达到设定值，就不再与延时较大的设备保存相同的节奏 



###### 方案限制因素

解码器流畅模式：根据源的帧率计算需要缓存多少帧之后才开始解码 
例如：源 60 fps/s  如果默认缓存 10帧 延时就是 160 ms

理论限制：
   1、放弃了解码器复用
   2、解码器流畅模式固定缓存N帧数据，实时性低
   3、同一个设备的两个HDMI口必须工作在相同的解码模式, vsync 独立。应用场景有部分限制   
   4、大屏上同一个源开多个窗口，多个窗口之间不保持同步
   5、源的帧率和大屏显示帧率保持一致时效果最好。否则可能显示卡顿问题
         ==> 解码器修改为根据时间戳解码，不根据帧率解码。看效果
   6、解码帧率和VO显示帧率一致，配大屏时需要修改 VO的刷新率



##### 高分主机编码同步方案           

高分主机会将同一帧画面分开编码为多路码流，如何保证在对于同一帧画面，编码出的多路码流中打上的时间戳相同？
   -- 多个编码器之间先保证 PTP 时钟同步
   -- 显卡采集画面的时候对于同一帧数据会有相同的标识？多个编码器编码时，针对具有相同标识的数据打上相同的时间戳。



#### 梳理关键流程及责任人

##### PTP 时钟同步基础

实现 PTP 时钟同步，保证各个设备之间纳秒级时钟同步

###### @基础平台开发(孙伟伟)

1、netcbb_daemon 程序集成了 linuxptp、phc2sys 源码

```shell
# 确认 ptp 相关线程是否正常启动
/bin # ps -T | grep netcbb_daemon
  399 admin     0:00 /bin/netcbb_daemon
  400 admin     0:00 {NetcbbSysRecvIp} /bin/netcbb_daemon
  401 admin     0:00 {NetcbbSysSendIp} /bin/netcbb_daemon
  402 admin     0:00 {NetcbbSysRecvIp} /bin/netcbb_daemon
  403 admin     0:00 {NetcbbSysSendIp} /bin/netcbb_daemon
  404 admin     0:00 {NetcbbSysNetlin} /bin/netcbb_daemon
  405 admin     0:00 {NetcbbRouteMoni} /bin/netcbb_daemon
  866 admin     0:00 grep netcbb_daemon
/bin #
/bin #
/bin # ps -ef | grep ptp4l_thread
  976 admin     0:00 grep ptp4l_thread
/bin #
/bin # ps -T | grep Phc2Sys_thread
  868 admin     0:00 grep ptp
```







###### @上海业务(王飞) 

1、提供集成了 PTP 时钟同步的编解码器版本



###### @显控业务(李永军)

1、控制节点配置支持 PTP 服务配置，作为 PTP 服务主时钟；并配置 NTP 服务与流媒体板保持时钟同步(流媒体GB35114鉴权需要校验时间)；

2、编解码盒子支持 PTP 同步验证



##### 解码输出同步方案


保证需要输出同步的多个解码节点在**同一时刻**开启 VO，保证 VSYNC 初始同步

###### @显控业务(李永军)
1、拼接屏配置阶段，触发多个解码器同一时刻使能 VO

![image-20250327183224614](vo_enable_vsync.png)

注意：

- 同时使能 VO 时，需要统一设置刷新率
- 延时开启 VO 使能的时刻可以支持配置文件设置
- 使能 VO 时，需要同步



###### @上海业务&媒控()

1、媒控需要支持模式配置
      vsync 解码模式，

2、



###### @苏州编码器(王林强)






<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
## 解决结果










<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
## 总结











<div STYLE="page-break-after: always;"></div>
<br>
<img src="./res/kedacom_logo.png" alt="kedacom" style="zoom:100%;margin-right:auto; margin-left:0; display:block;" />

***
## 引用
